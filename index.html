<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Universal AI - Pro Version</title>
    
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries,typography"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#135bec",
                        "primary-hover": "#0f4bc2",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                        "surface-light": "#ffffff",
                        "surface-dark": "#1e293b",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"],
                        "body": ["Inter", "sans-serif"],
                    },
                    typography: {
                        DEFAULT: {
                            css: {
                                maxWidth: '100%',
                                pre: {
                                    backgroundColor: '#1e293b',
                                    color: '#f8fafc',
                                    borderRadius: '0.75rem',
                                    padding: '1rem',
                                },
                                code: {
                                    color: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    padding: '0.2rem 0.4rem',
                                    borderRadius: '0.25rem',
                                    fontWeight: '500',
                                },
                                'code::before': { content: '""' },
                                'code::after': { content: '""' }
                            }
                        }
                    }
                },
            },
        }
    </script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.3); border-radius: 20px; }
        .custom-scrollbar:hover::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.5); }
        
        textarea::-webkit-scrollbar { display: none; }
        textarea { -ms-overflow-style: none; scrollbar-width: none; }

        /* Gradient text */
        .text-gradient {
            background: linear-gradient(to right, #4285f4, #d96570);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .chat-bubble-user { background-color: #f1f5f9; color: #1e293b; border-radius: 1.5rem 1.5rem 0 1.5rem; }
        .dark .chat-bubble-user { background-color: #334155; color: #f8fafc; }

        .fade-enter { opacity: 0; transform: translateY(10px); animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* Typing Indicator */
        .typing-indicator span {
            display: inline-block; width: 6px; height: 6px; background-color: #9ca3af; border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-slate-900 dark:text-slate-100 h-screen overflow-hidden flex selection:bg-primary/20 transition-colors duration-300">

    <div id="loading" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-white dark:bg-[#131314]">
        <div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-slate-600 dark:text-slate-300 font-medium">Initializing Workspace...</p>
    </div>

    <div id="app" class="hidden flex-1 flex w-full h-full relative">
        
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

        <aside id="sidebar" class="fixed md:static inset-y-0 left-0 z-40 w-[280px] h-full bg-[#f0f4f9] dark:bg-[#131314] flex flex-col justify-between transform -translate-x-full md:translate-x-0 transition-transform duration-300 shrink-0 border-r border-slate-200 dark:border-slate-800 md:border-none">
            
            <div class="p-3 flex flex-col gap-6 h-[calc(100%-140px)]">
                <div class="px-2 pt-2 flex items-center justify-between">
                    <button id="close-sidebar-btn" class="md:hidden p-2 rounded-full hover:bg-black/5 dark:hover:bg-white/10 text-slate-600 dark:text-slate-300 transition-colors">
                        <span class="material-symbols-outlined">menu_open</span>
                    </button>
                    <div class="hidden md:block p-2 text-slate-600 dark:text-slate-300">
                        <span class="material-symbols-outlined font-bold text-xl">blur_on</span>
                    </div>
                </div>
                
                <button id="new-chat-btn" class="flex items-center gap-3 bg-[#dde3ea] dark:bg-[#1f1f1f] text-slate-700 dark:text-slate-200 px-4 py-3 rounded-xl hover:bg-[#d1d9e2] dark:hover:bg-[#2f2f2f] transition-colors w-max shadow-sm">
                    <span class="material-symbols-outlined text-primary" style="font-size: 20px;">add</span>
                    <span class="text-sm font-medium">New chat</span>
                </button>
                
                <div class="flex flex-col gap-2 mt-2 flex-1 overflow-hidden">
                    <div class="px-3 text-xs font-medium text-slate-500 dark:text-slate-400">Recent</div>
                    <div id="chat-list" class="custom-scrollbar overflow-y-auto flex-1 flex flex-col gap-1 pr-2 pb-4">
                        </div>
                </div>
            </div>

            <div class="p-3 flex flex-col gap-1 border-t border-slate-200 dark:border-slate-800 md:border-none">
                <button id="open-settings-btn" class="flex items-center gap-3 px-3 py-2.5 rounded-full hover:bg-[#e4e9ef] dark:hover:bg-[#28292a] text-slate-700 dark:text-slate-300 text-sm font-medium transition-colors">
                    <span class="material-symbols-outlined text-xl">settings</span> Settings
                </button>
                <div class="flex items-center justify-between px-3 py-2 mt-2">
                    <div class="flex items-center gap-2">
                        <div class="size-2 rounded-full bg-green-500"></div>
                        <span id="current-model-display" class="text-xs text-slate-500 dark:text-slate-400 truncate max-w-[120px]">Gemini Pro</span>
                    </div>
                    <span class="text-xs text-slate-400 dark:text-slate-500">v2.0</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full relative bg-surface-light dark:bg-background-dark md:rounded-l-3xl shadow-2xl overflow-hidden w-full">
            
            <div class="md:hidden flex items-center justify-between p-4 border-b border-slate-200 dark:border-slate-800 bg-surface-light/80 dark:bg-background-dark/80 backdrop-blur-md z-20">
                <button id="open-sidebar-btn" class="p-2 -ml-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <h1 class="text-lg font-medium text-slate-800 dark:text-white">Universal AI</h1>
                <button id="theme-toggle-mobile" class="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300">
                    <span class="material-symbols-outlined">lightbulb</span>
                </button>
            </div>

            <div class="absolute top-4 right-6 flex items-center gap-3 z-20 hidden md:flex">
                <button id="theme-toggle" class="flex items-center justify-center p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-colors" title="Toggle Theme">
                    <span id="theme-icon" class="material-symbols-outlined">dark_mode</span>
                </button>
                <div class="bg-gradient-to-tr from-blue-500 to-purple-500 p-[2px] rounded-full cursor-pointer hover:shadow-lg transition-shadow">
                    <div class="size-8 rounded-full bg-white dark:bg-slate-900 flex items-center justify-center text-primary font-bold text-sm">
                        U
                    </div>
                </div>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto custom-scrollbar flex flex-col items-center pt-6 md:pt-10 pb-40 px-4 md:px-0 w-full scroll-smooth">
                
                <div id="welcome-screen" class="w-full max-w-[800px] flex flex-col gap-10 mt-10 md:mt-20 fade-enter">
                    <div class="space-y-2 pl-2 md:pl-0">
                        <h1 class="text-4xl md:text-6xl font-medium tracking-tight text-slate-300 dark:text-slate-700">
                            <span class="text-gradient font-semibold">Hello, Explorer.</span>
                        </h1>
                        <h2 class="text-3xl md:text-5xl font-medium tracking-tight text-[#c4c7c5] dark:text-[#444746] mt-2">How can I help you today?</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 w-full px-2 md:px-0 mt-8">
                        <button class="prompt-btn flex flex-col gap-3 p-4 rounded-xl bg-slate-50 dark:bg-[#1e1f20] hover:bg-slate-100 dark:hover:bg-[#2d2e2f] transition-all text-left border border-transparent hover:border-slate-200 dark:hover:border-slate-700 h-40 justify-between group shadow-sm">
                            <p class="text-slate-700 dark:text-slate-200 font-medium text-sm">Write a professional email for a sick day off</p>
                            <div class="self-end p-2 rounded-full bg-white dark:bg-black/20 group-hover:bg-white dark:group-hover:bg-black/40 transition-colors">
                                <span class="material-symbols-outlined text-primary text-xl">mail</span>
                            </div>
                        </button>
                        <button class="prompt-btn flex flex-col gap-3 p-4 rounded-xl bg-slate-50 dark:bg-[#1e1f20] hover:bg-slate-100 dark:hover:bg-[#2d2e2f] transition-all text-left border border-transparent hover:border-slate-200 dark:hover:border-slate-700 h-40 justify-between group shadow-sm">
                            <p class="text-slate-700 dark:text-slate-200 font-medium text-sm">Explain Quantum Computing in simple terms</p>
                            <div class="self-end p-2 rounded-full bg-white dark:bg-black/20 group-hover:bg-white dark:group-hover:bg-black/40 transition-colors">
                                <span class="material-symbols-outlined text-purple-500 text-xl">science</span>
                            </div>
                        </button>
                        <button class="prompt-btn flex flex-col gap-3 p-4 rounded-xl bg-slate-50 dark:bg-[#1e1f20] hover:bg-slate-100 dark:hover:bg-[#2d2e2f] transition-all text-left border border-transparent hover:border-slate-200 dark:hover:border-slate-700 h-40 justify-between group shadow-sm">
                            <p class="text-slate-700 dark:text-slate-200 font-medium text-sm">Plan a 3-day tourist itinerary for Tokyo</p>
                            <div class="self-end p-2 rounded-full bg-white dark:bg-black/20 group-hover:bg-white dark:group-hover:bg-black/40 transition-colors">
                                <span class="material-symbols-outlined text-green-500 text-xl">flight</span>
                            </div>
                        </button>
                        <button class="prompt-btn flex flex-col gap-3 p-4 rounded-xl bg-slate-50 dark:bg-[#1e1f20] hover:bg-slate-100 dark:hover:bg-[#2d2e2f] transition-all text-left border border-transparent hover:border-slate-200 dark:hover:border-slate-700 h-40 justify-between group shadow-sm">
                            <p class="text-slate-700 dark:text-slate-200 font-medium text-sm">Help me design a SQL database schema</p>
                            <div class="self-end p-2 rounded-full bg-white dark:bg-black/20 group-hover:bg-white dark:group-hover:bg-black/40 transition-colors">
                                <span class="material-symbols-outlined text-orange-500 text-xl">dataset</span>
                            </div>
                        </button>
                    </div>
                </div>

                <div id="messages-container" class="w-full max-w-[800px] flex flex-col gap-8 px-2 md:px-0 hidden pb-10">
                    </div>
                
                <div id="typing-indicator" class="w-full max-w-[800px] px-2 md:px-0 hidden mt-4">
                    <div class="flex gap-4">
                        <div class="size-8 rounded-full bg-gradient-to-tr from-blue-500 via-purple-500 to-red-500 shrink-0 mt-1 animate-spin" style="animation-duration: 3s;"></div>
                        <div class="flex flex-col gap-2 justify-center bg-slate-50 dark:bg-[#1e1f20] px-4 py-3 rounded-2xl rounded-tl-none border border-slate-100 dark:border-slate-800">
                            <div class="typing-indicator flex gap-1">
                                <span></span><span></span><span></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-surface-light via-surface-light to-transparent dark:from-background-dark dark:via-background-dark pt-10 pb-6 px-4 z-20">
                <div class="max-w-[800px] mx-auto relative">
                    
                    <div id="error-banner" class="hidden absolute -top-12 left-0 right-0 bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 px-4 py-2 rounded-lg text-sm text-center shadow-sm">
                        Error message here.
                    </div>

                    <div class="bg-[#f0f4f9] dark:bg-[#1e1f20] rounded-3xl pl-4 pr-2 py-2 flex items-end gap-2 focus-within:shadow-lg focus-within:bg-white dark:focus-within:bg-[#2d2e2f] transition-all border border-slate-200 dark:border-slate-700 shadow-md">
                        
                        <button class="p-3 mb-1 rounded-full text-slate-500 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 hover:bg-black/5 dark:hover:bg-white/10 transition-colors shrink-0">
                            <span class="material-symbols-outlined">add_photo_alternate</span>
                        </button>
                        
                        <textarea id="user-input" class="w-full bg-transparent border-none focus:ring-0 text-slate-800 dark:text-slate-100 placeholder-slate-500 dark:placeholder-slate-400 resize-none py-3.5 max-h-[200px] text-base leading-relaxed" placeholder="Message AI..." rows="1" style="min-height: 52px;"></textarea>
                        
                        <div class="flex items-center mb-1 shrink-0 gap-1">
                            <button id="stop-btn" class="hidden p-3 rounded-full text-red-500 hover:bg-red-50 dark:hover:bg-red-500/10 transition-colors" title="Stop Generation">
                                <span class="material-symbols-outlined">stop_circle</span>
                            </button>
                            <button id="send-btn" class="p-3 rounded-full text-white bg-primary hover:bg-primary-hover transition-colors disabled:opacity-50 disabled:bg-slate-300 dark:disabled:bg-slate-700 disabled:text-slate-500 shadow-sm flex items-center justify-center">
                                <span class="material-symbols-outlined text-[20px] translate-x-[2px]">send</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="text-center mt-3">
                        <p class="text-xs text-slate-500 dark:text-slate-400">
                            AI may generate incorrect info. Always verify important details. Powered by OpenRouter.
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300 px-4">
        <div class="bg-white dark:bg-[#1e1f20] w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-700 transform scale-95 transition-transform duration-300" id="settings-content">
            <div class="px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center bg-slate-50/50 dark:bg-[#1a1a1a]">
                <h3 class="text-xl font-semibold text-slate-800 dark:text-white flex items-center gap-2">
                    <span class="material-symbols-outlined text-primary">manage_accounts</span> Settings
                </h3>
                <button id="close-settings-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800 hover:text-slate-700 dark:hover:text-slate-200 transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <div class="p-6 flex flex-col gap-6 max-h-[70vh] overflow-y-auto custom-scrollbar">
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">OpenRouter API Key <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <input id="api-key-input" class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-[#0b0c0d] text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary pl-10 py-2.5 transition-shadow" placeholder="sk-or-v1-..." type="password"/>
                        <span class="material-symbols-outlined absolute left-3 top-3 text-slate-400 text-[20px]">key</span>
                    </div>
                    <p class="text-xs text-slate-500">Stored securely only in your browser's local storage.</p>
                </div>
                
                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">AI Model</label>
                    <div class="relative">
                        <select id="model-input" class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-[#0b0c0d] text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary appearance-none pl-10 py-2.5 transition-shadow">
                            <option value="google/gemini-pro">Google: Gemini Pro</option>
                            <option value="google/gemini-flash-1.5">Google: Gemini Flash 1.5</option>
                            <option value="openai/gpt-4o">OpenAI: GPT-4o</option>
                            <option value="openai/gpt-3.5-turbo">OpenAI: GPT-3.5 Turbo</option>
                            <option value="anthropic/claude-3-haiku">Anthropic: Claude 3 Haiku</option>
                            <option value="deepseek/deepseek-chat">DeepSeek: Chat</option>
                            <option value="meta-llama/llama-3-8b-instruct:free">Meta: LLaMA 3 8B (Free)</option>
                        </select>
                        <span class="material-symbols-outlined absolute left-3 top-3 text-slate-400 text-[20px]">memory</span>
                        <span class="material-symbols-outlined absolute right-3 top-3 text-slate-400 pointer-events-none">expand_more</span>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <label class="text-sm font-semibold text-slate-700 dark:text-slate-300">System Prompt</label>
                    <textarea id="system-prompt-input" rows="3" class="w-full rounded-xl border border-slate-300 dark:border-slate-600 bg-white dark:bg-[#0b0c0d] text-slate-900 dark:text-slate-100 focus:ring-2 focus:ring-primary focus:border-primary px-4 py-3 resize-none transition-shadow custom-scrollbar" placeholder="You are a helpful AI assistant."></textarea>
                </div>
            </div>
            
            <div class="px-6 py-4 border-t border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-[#1a1a1a] flex justify-end gap-3">
                <button id="cancel-settings-btn" class="px-5 py-2.5 rounded-xl font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-800 transition-colors">Cancel</button>
                <button id="save-settings-btn" class="bg-primary hover:bg-primary-hover text-white px-6 py-2.5 rounded-xl font-medium transition-colors shadow-md flex items-center gap-2">
                    <span class="material-symbols-outlined text-[18px]">save</span> Save Config
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // ==========================================
            // STATE MANAGEMENT
            // ==========================================
            const STATE = {
                chats: [],
                currentChatId: null,
                settings: {
                    apiKey: '',
                    model: 'google/gemini-pro',
                    systemPrompt: 'You are a helpful, intelligent, and accurate AI assistant. Format your responses using Markdown.',
                    theme: 'dark'
                },
                isGenerating: false,
                abortController: null
            };

            // ==========================================
            // DOM ELEMENTS
            // ==========================================
            const DOM = {
                loading: document.getElementById('loading'),
                app: document.getElementById('app'),
                sidebar: document.getElementById('sidebar'),
                sidebarOverlay: document.getElementById('sidebar-overlay'),
                chatContainer: document.getElementById('chat-container'),
                welcomeScreen: document.getElementById('welcome-screen'),
                messagesContainer: document.getElementById('messages-container'),
                chatList: document.getElementById('chat-list'),
                userInput: document.getElementById('user-input'),
                sendBtn: document.getElementById('send-btn'),
                stopBtn: document.getElementById('stop-btn'),
                errorBanner: document.getElementById('error-banner'),
                typingIndicator: document.getElementById('typing-indicator'),
                
                // Buttons
                newChatBtn: document.getElementById('new-chat-btn'),
                openSidebarBtn: document.getElementById('open-sidebar-btn'),
                closeSidebarBtn: document.getElementById('close-sidebar-btn'),
                themeToggle: document.getElementById('theme-toggle'),
                themeToggleMobile: document.getElementById('theme-toggle-mobile'),
                themeIcon: document.getElementById('theme-icon'),
                openSettingsBtn: document.getElementById('open-settings-btn'),
                promptBtns: document.querySelectorAll('.prompt-btn'),
                
                // Modal
                settingsModal: document.getElementById('settings-modal'),
                settingsContent: document.getElementById('settings-content'),
                closeSettingsBtn: document.getElementById('close-settings-btn'),
                cancelSettingsBtn: document.getElementById('cancel-settings-btn'),
                saveSettingsBtn: document.getElementById('save-settings-btn'),
                apiKeyInput: document.getElementById('api-key-input'),
                modelInput: document.getElementById('model-input'),
                systemPromptInput: document.getElementById('system-prompt-input'),
                currentModelDisplay: document.getElementById('current-model-display')
            };

            // ==========================================
            // INITIALIZATION
            // ==========================================
            function init() {
                loadData();
                applyTheme();
                
                // Markdown Config
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    highlight: function(code, lang) {
                        return code; // Can add highlight.js here if desired later
                    }
                });

                if (STATE.chats.length === 0) {
                    createNewChat();
                } else {
                    if (!STATE.chats.find(c => c.id === STATE.currentChatId)) {
                        STATE.currentChatId = STATE.chats[0].id;
                    }
                    renderSidebar();
                    renderCurrentChat();
                }

                setupEventListeners();
                updateSettingsUI();

                setTimeout(() => {
                    DOM.loading.style.display = 'none';
                    DOM.app.classList.remove('hidden');
                    adjustTextareaHeight();
                }, 500);
            }

            // ==========================================
            // LOCAL STORAGE
            // ==========================================
            function loadData() {
                try {
                    const savedSettings = localStorage.getItem('univ_ai_settings');
                    if (savedSettings) STATE.settings = { ...STATE.settings, ...JSON.parse(savedSettings) };
                    
                    const savedChats = localStorage.getItem('univ_ai_chats');
                    if (savedChats) STATE.chats = JSON.parse(savedChats);
                    
                    const savedCurrentChat = localStorage.getItem('univ_ai_current');
                    if (savedCurrentChat) STATE.currentChatId = savedCurrentChat;
                } catch (e) {
                    console.error("Storage load error:", e);
                }
            }

            function saveData() {
                try {
                    localStorage.setItem('univ_ai_settings', JSON.stringify(STATE.settings));
                    localStorage.setItem('univ_ai_chats', JSON.stringify(STATE.chats));
                    localStorage.setItem('univ_ai_current', STATE.currentChatId);
                } catch (e) {
                    console.error("Storage save error:", e);
                }
            }

            // ==========================================
            // THEME MANAGEMENT
            // ==========================================
            function applyTheme() {
                if (STATE.settings.theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    DOM.themeIcon.textContent = 'light_mode';
                } else {
                    document.documentElement.classList.remove('dark');
                    DOM.themeIcon.textContent = 'dark_mode';
                }
            }

            function toggleTheme() {
                STATE.settings.theme = STATE.settings.theme === 'dark' ? 'light' : 'dark';
                applyTheme();
                saveData();
            }

            // ==========================================
            // CHAT LOGIC
            // ==========================================
            function generateId() {
                return 'id-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            }

            function createNewChat() {
                const newChat = {
                    id: generateId(),
                    title: 'New Conversation',
                    messages: [],
                    updatedAt: Date.now()
                };
                STATE.chats.unshift(newChat);
                STATE.currentChatId = newChat.id;
                saveData();
                renderSidebar();
                renderCurrentChat();
                if(window.innerWidth < 768) toggleSidebar(false);
            }

            function deleteChat(id, e) {
                e.stopPropagation();
                STATE.chats = STATE.chats.filter(c => c.id !== id);
                if (STATE.chats.length === 0) {
                    createNewChat();
                } else if (STATE.currentChatId === id) {
                    STATE.currentChatId = STATE.chats[0].id;
                }
                saveData();
                renderSidebar();
                renderCurrentChat();
            }

            function switchChat(id) {
                if(STATE.isGenerating) return; // Prevent switch during gen
                STATE.currentChatId = id;
                saveData();
                renderSidebar();
                renderCurrentChat();
                if(window.innerWidth < 768) toggleSidebar(false);
            }

            function getCurrentChat() {
                return STATE.chats.find(c => c.id === STATE.currentChatId);
            }

            // ==========================================
            // UI RENDERING
            // ==========================================
            function renderSidebar() {
                DOM.chatList.innerHTML = '';
                
                STATE.chats.forEach(chat => {
                    const isActive = chat.id === STATE.currentChatId;
                    
                    const div = document.createElement('div');
                    div.className = `group flex items-center gap-3 px-3 py-2.5 rounded-full cursor-pointer transition-colors ${
                        isActive 
                        ? 'bg-[#dde3ea] dark:bg-[#282a2c] text-slate-900 dark:text-slate-100' 
                        : 'hover:bg-[#e4e9ef] dark:hover:bg-[#1e1f20] text-slate-700 dark:text-slate-300'
                    }`;
                    div.onclick = () => switchChat(chat.id);
                    
                    div.innerHTML = `
                        <span class="material-symbols-outlined text-[18px] opacity-70">chat_bubble</span>
                        <span class="text-sm truncate flex-1 font-medium">${chat.title}</span>
                        <div class="flex gap-1 ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'} transition-opacity">
                            <button class="delete-btn p-1 hover:text-red-500 rounded-full hover:bg-white dark:hover:bg-black/20 transition-colors" title="Delete">
                                <span class="material-symbols-outlined text-[16px] block">delete</span>
                            </button>
                        </div>
                    `;
                    
                    div.querySelector('.delete-btn').onclick = (e) => deleteChat(chat.id, e);
                    DOM.chatList.appendChild(div);
                });
            }

            function renderCurrentChat() {
                const chat = getCurrentChat();
                if (!chat) return;

                if (chat.messages.length === 0) {
                    DOM.welcomeScreen.classList.remove('hidden');
                    DOM.messagesContainer.classList.add('hidden');
                    DOM.messagesContainer.innerHTML = '';
                } else {
                    DOM.welcomeScreen.classList.add('hidden');
                    DOM.messagesContainer.classList.remove('hidden');
                    DOM.messagesContainer.innerHTML = '';
                    
                    chat.messages.forEach(msg => {
                        appendMessageToDOM(msg.role, msg.content);
                    });
                    scrollToBottom();
                }
            }

            function appendMessageToDOM(role, content) {
                const isUser = role === 'user';
                const wrapper = document.createElement('div');
                wrapper.className = `flex ${isUser ? 'justify-end' : 'justify-start gap-4'} w-full fade-enter`;

                if (isUser) {
                    wrapper.innerHTML = `
                        <div class="chat-bubble-user px-5 py-3.5 max-w-[85%] md:max-w-[75%] shadow-sm border border-slate-200 dark:border-slate-700">
                            <div class="text-sm md:text-base leading-relaxed whitespace-pre-wrap font-medium">${escapeHTML(content)}</div>
                        </div>
                    `;
                } else {
                    const parsedHTML = DOMPurify.sanitize(marked.parse(content));
                    wrapper.innerHTML = `
                        <div class="size-8 md:size-10 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 shrink-0 mt-1 flex items-center justify-center text-white shadow-md">
                            <span class="material-symbols-outlined text-lg">blur_on</span>
                        </div>
                        <div class="flex flex-col gap-2 flex-1 min-w-0 max-w-[calc(100%-48px)]">
                            <div class="prose dark:prose-invert prose-slate max-w-none text-slate-800 dark:text-slate-200 text-sm md:text-base leading-relaxed break-words bg-transparent">
                                ${parsedHTML}
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button class="copy-btn p-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-[#282a2c] text-slate-400 hover:text-slate-700 dark:hover:text-slate-200 transition-colors" title="Copy">
                                    <span class="material-symbols-outlined text-[18px] block">content_copy</span>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add copy functionality
                    const copyBtn = wrapper.querySelector('.copy-btn');
                    copyBtn.onclick = () => {
                        navigator.clipboard.writeText(content);
                        const icon = copyBtn.querySelector('span');
                        icon.textContent = 'check';
                        icon.classList.add('text-green-500');
                        setTimeout(() => {
                            icon.textContent = 'content_copy';
                            icon.classList.remove('text-green-500');
                        }, 2000);
                    };
                }

                DOM.messagesContainer.appendChild(wrapper);
                scrollToBottom();
            }

            // ==========================================
            // API & GENERATION LOGIC
            // ==========================================
            async function handleSend(forcedPrompt = null) {
                if (STATE.isGenerating) return;
                
                const text = forcedPrompt || DOM.userInput.value.trim();
                if (!text) return;

                // Validate API Key
                if (!STATE.settings.apiKey) {
                    showError("Please set your OpenRouter API Key in settings first.");
                    openSettings();
                    return;
                }

                const chat = getCurrentChat();
                
                // Update UI
                DOM.userInput.value = '';
                adjustTextareaHeight();
                hideError();
                
                // Add user message
                chat.messages.push({ role: 'user', content: text });
                chat.updatedAt = Date.now();
                
                // Generate title if it's the first message
                if (chat.messages.length === 1) {
                    chat.title = text.length > 30 ? text.substring(0, 30) + '...' : text;
                }
                
                saveData();
                renderSidebar();
                
                if (DOM.welcomeScreen.classList.contains('hidden') === false) {
                    DOM.welcomeScreen.classList.add('hidden');
                    DOM.messagesContainer.classList.remove('hidden');
                }
                
                appendMessageToDOM('user', text);
                
                // Prepare API request
                await callAI(chat);
            }

            async function callAI(chat) {
                STATE.isGenerating = true;
                updateInputState();
                DOM.typingIndicator.classList.remove('hidden');
                scrollToBottom();

                STATE.abortController = new AbortController();

                // Build Message History
                const messages = [
                    { role: "system", content: STATE.settings.systemPrompt },
                    ...chat.messages.map(m => ({ role: m.role, content: m.content }))
                ];

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${STATE.settings.apiKey}`,
                            "HTTP-Referer": window.location.href,
                            "X-Title": "Universal AI Pro",
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            model: STATE.settings.model,
                            messages: messages,
                            stream: false // Using non-streaming for simplicity & reliability in this mega-file
                        }),
                        signal: STATE.abortController.signal
                    });

                    DOM.typingIndicator.classList.add('hidden');

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                    }

                    const data = await response.json();
                    const aiContent = data.choices[0].message.content;

                    chat.messages.push({ role: 'assistant', content: aiContent });
                    saveData();
                    appendMessageToDOM('assistant', aiContent);

                } catch (error) {
                    DOM.typingIndicator.classList.add('hidden');
                    if (error.name === 'AbortError') {
                        showError("Generation stopped by user.");
                    } else {
                        showError(error.message);
                        // Optionally remove the last user message if it failed
                        // chat.messages.pop();
                    }
                } finally {
                    STATE.isGenerating = false;
                    STATE.abortController = null;
                    updateInputState();
                    DOM.userInput.focus();
                }
            }

            function stopGeneration() {
                if (STATE.abortController) {
                    STATE.abortController.abort();
                }
            }

            // ==========================================
            // HELPERS & EVENT LISTENERS
            // ==========================================
            function escapeHTML(str) {
                return str.replace(/[&<>'"]/g, tag => ({
                    '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
                }[tag]));
            }

            function scrollToBottom() {
                setTimeout(() => {
                    DOM.chatContainer.scrollTo({
                        top: DOM.chatContainer.scrollHeight,
                        behavior: 'smooth'
                    });
                }, 50);
            }

            function adjustTextareaHeight() {
                DOM.userInput.style.height = 'auto';
                DOM.userInput.style.height = (DOM.userInput.scrollHeight) + 'px';
                if(DOM.userInput.value === '') DOM.userInput.style.height = '52px';
            }

            function updateInputState() {
                if (STATE.isGenerating) {
                    DOM.sendBtn.classList.add('hidden');
                    DOM.stopBtn.classList.remove('hidden');
                    DOM.userInput.disabled = true;
                    DOM.userInput.classList.add('opacity-50');
                } else {
                    DOM.sendBtn.classList.remove('hidden');
                    DOM.stopBtn.classList.add('hidden');
                    DOM.userInput.disabled = false;
                    DOM.userInput.classList.remove('opacity-50');
                    updateSendBtnState();
                }
            }

            function updateSendBtnState() {
                DOM.sendBtn.disabled = DOM.userInput.value.trim() === '';
            }

            function showError(msg) {
                DOM.errorBanner.textContent = msg;
                DOM.errorBanner.classList.remove('hidden');
                setTimeout(hideError, 5000);
            }
            function hideError() { DOM.errorBanner.classList.add('hidden'); }

            // Sidebar toggles
            function toggleSidebar(show = true) {
                if(show) {
                    DOM.sidebar.classList.remove('-translate-x-full');
                    DOM.sidebarOverlay.classList.remove('hidden');
                } else {
                    DOM.sidebar.classList.add('-translate-x-full');
                    DOM.sidebarOverlay.classList.add('hidden');
                }
            }

            // Settings Modal
            function openSettings() {
                DOM.apiKeyInput.value = STATE.settings.apiKey;
                DOM.modelInput.value = STATE.settings.model;
                DOM.systemPromptInput.value = STATE.settings.systemPrompt;
                
                DOM.settingsModal.classList.remove('hidden');
                // slight delay for animation
                setTimeout(() => {
                    DOM.settingsModal.classList.remove('opacity-0');
                    DOM.settingsContent.classList.remove('scale-95');
                }, 10);
            }

            function closeSettings() {
                DOM.settingsModal.classList.add('opacity-0');
                DOM.settingsContent.classList.add('scale-95');
                setTimeout(() => {
                    DOM.settingsModal.classList.add('hidden');
                }, 300);
            }

            function saveSettings() {
                STATE.settings.apiKey = DOM.apiKeyInput.value.trim();
                STATE.settings.model = DOM.modelInput.value;
                STATE.settings.systemPrompt = DOM.systemPromptInput.value.trim();
                saveData();
                updateSettingsUI();
                closeSettings();
            }

            function updateSettingsUI() {
                const select = DOM.modelInput;
                const text = select.options[select.selectedIndex]?.text || STATE.settings.model;
                DOM.currentModelDisplay.textContent = text.split(':')[0]; // Shorten display name
            }

            // Setup Listeners
            function setupEventListeners() {
                // Input
                DOM.userInput.addEventListener('input', () => {
                    adjustTextareaHeight();
                    updateSendBtnState();
                });
                
                DOM.userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSend();
                    }
                });

                DOM.sendBtn.addEventListener('click', () => handleSend());
                DOM.stopBtn.addEventListener('click', stopGeneration);

                // Prompts
                DOM.promptBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const text = btn.querySelector('p').textContent;
                        handleSend(text);
                    });
                });

                // Sidebar & UI
                DOM.newChatBtn.addEventListener('click', createNewChat);
                DOM.themeToggle.addEventListener('click', toggleTheme);
                DOM.themeToggleMobile.addEventListener('click', toggleTheme);
                
                DOM.openSidebarBtn.addEventListener('click', () => toggleSidebar(true));
                DOM.closeSidebarBtn.addEventListener('click', () => toggleSidebar(false));
                DOM.sidebarOverlay.addEventListener('click', () => toggleSidebar(false));

                // Settings
                DOM.openSettingsBtn.addEventListener('click', openSettings);
                DOM.closeSettingsBtn.addEventListener('click', closeSettings);
                DOM.cancelSettingsBtn.addEventListener('click', closeSettings);
                DOM.saveSettingsBtn.addEventListener('click', saveSettings);
                
                DOM.settingsModal.addEventListener('click', (e) => {
                    if (e.target === DOM.settingsModal) closeSettings();
                });
            }

            // Start App
            init();
        });
    </script>
</body>
</html>
